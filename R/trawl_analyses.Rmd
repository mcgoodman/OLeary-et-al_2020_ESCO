---
title: "Morro Bay Trawl Analyses"
author: "Maurice Goodman"
date: "Updated September 2020"
output: pdf_document
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(checkpoint)
checkpoint("2020-09-01")

library(here)
source(here("R", "packages.R"))

knitr::opts_chunk$set(fig.height = 6, fig.width = 10, message = FALSE, warning = FALSE)
options(knitr.kable.NA = '')

theme_trawls <- theme_classic() +
  theme(axis.line.x = element_line(size = 1), 
        axis.line.y = element_line(size = 1), 
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(0.4, "lines"),
        strip.background = element_blank(),
        axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 16, face = "bold"),
        strip.text = element_text(size = 18, face = "bold", margin = margin(0,0,4,0)),
        legend.text = element_text(size = 14, margin = margin(0, 4, 0, 4)), 
        legend.title = element_text(size = 14, face = "bold"),
        strip.placement = "outside")

source(here("R", "cluster_bootstrap.R"))
```


This document contains analyses of trawl data from **O'Leary et al., "Effects of estuary-wide seagrass loss on fish populations"**, submitted to the journal *Estuaries and Coasts* and in review as of September 2020. Not all code is shown in document output, but code for plots or analyses which are not shown below can be viewed in the R markdown source code.

# Metadata

## Data Description 

Trawl surveys were conducted before (2006-2007) and after (2016-2017) the eelgrass decline at the same seven sites in Morro Bay (Figure 1a) during high tide (post-decline: intertidal flats 0.93 ± 0.08 m SE MLLW, channel 1.17 ± 0.06 m SE MLLW; unrecorded during pre-decline period). We surveyed four sites in the back-bay intertidal flats using a beam trawl (2 m wide at the mouth, 4 m long, with a 1 m reinforced cod end and a 4 mm mesh size). The mean depth of the beam trawls was 1.0 ± 0.06 m (SE). The remaining three sites surveyed were in the channel running from the mid-bay to the bay mouth. The channel is dredged annually and is too deep for eelgrass to survive, but has persistent eelgrass along the margins. We surveyed the channel sites using an otter trawl (4.6 m wide at the mouth, 7.2 m long with a mesh size of 14 mm in the wings and 8 mm in the code end). The mean depth of channel trawls was 5.3 ± 0.2 m (SE). The size of the trawls used was based on the equipment used in the early period, and we replicated prior methods for the 2016-2017 surveys. Though trawl size between the two habitats varied, we do not explicitly compare the trawl types, but rather compare results between seasons and period for each respective trawl type. 

In both pre- and post-decline periods, the trawls (beam and otter) were 10-11 minutes long at a speed (over ground) of 0.8 – 1.8 knots. In both periods, trawls were conducted during two seasons: October-November (fall) and June-August (summer). In the pre-decline period (2006-2007), we conducted three replicate trawls per site in six sites per season per year, with data collected in the summer and fall of both years. In the intertidal flats during the pre-decline period, sites B1, B2, and B4 were consistently surveyed using a beam trawl except in the summer of 2006, when site B3 was surveyed instead of site B4 (Figure 1b).  In the post-decline period (2016-2017), we conducted three replicate trawls per site per season per year at all seven sites (Figure 1b), with surveys conducted in the fall of 2016 and the summer of 2017. The only exceptions to replication level in the post-decline period were that in the fall of 2016 where we were only able to conduct two replicate trawls at channel site O3, and we conducted four replicate trawls at intertidal site 2. At the end of each trawl (otter and beam), all organisms were removed from the trawl nets, fish were identified to species, and the total length of each fish was measured to the nearest mm. Fish were returned alive to the water at their collection site. 


## Sample Size Breakdown

Below is a table of sample sizes for each site, broken down by period (pre-decline, 2006-2007, or post-decline, 2016-2017) and season (Fall or Summer). "Beam" sites are those conducted in the mudflats, while "otter" sites were conducted in the channel. The data are unbalanced, with between 2 and 6 observations per site in each period and season. Site Beam 3 was not sampled in the pre-decline period in the Fall, and we therefore exclude it from analyses.

This yields a total of 52 observations across three sites in the channel, and 53 observations across three sites in the mudflats.

```{r sample_size}
trawl_path <- here("data", "MB_Trawl_Data_2006_2017.xlsx")

season_year <- function(x) separate(x, Period, into = c("Season", "Year"), sep = " ")

trawl_info <- read_excel(trawl_path, sheet = "Trawl Information")
trawl_info <- season_year(trawl_info)
trawl_info$Period <- ifelse(trawl_info$Year <= 2007, "Pre-Decline", "Post-Decline")

trawl_info %>%
  group_by(Period, Season, Site) %>% 
  filter(Year != "2008" & Season != "Spring") %>% tally() %>% 
  pivot_wider(names_from = Site, values_from = n) %>% 
  knitr::kable()
```

## Tide Level Estimates

During both time periods, trawls were conducted during high tide. However, trawl start and end times were not recorded for trawls conducted before decline. Just as a check, here are estimated tidal heights for the fall and summer trawls following Eelgrass decline, in both habitats, confirming that trawls were conducted during high tide.

```{r tides}
trawl_tides <- trawl_info %>% filter(!is.na(StartTime))

trawl_tides$StartTime %<>% 
  map_chr(function(x) strsplit(as.character(x), split = " ")[[1]][2])
trawl_tides$StartTime <-
  as.POSIXct(paste(as.character(trawl_tides$Date), trawl_tides$StartTime), 
            tz = "America/Los_Angeles")

tide_data <- data.frame(Station = "Port San Luis, Pacific Ocean, California",
                        DateTime = trawl_tides$StartTime, 
                        stringsAsFactors = FALSE)

tide_data <- rtide::tide_height_data(tide_data)
trawl_tides$tide <- tide_data$TideHeight

trawl_tides %>% 
  group_by(`trawl type` = TrawlType, Season) %>% 
   summarize(mean = round(mean(tide), 3), 
            `standard error` = round(sd(tide)/sqrt(n()), 3)) %>% 
  knitr::kable()
```

## Trawl Depths

Likewise, these data only exist for trawls conducted between 2016 and 2017.

```{r depth}
trawl_tides %>% 
  filter(!is.na(StartDepth_ft) | is.na(EndDepth_ft)) %>% 
  mutate(mean_depth = ((StartDepth_ft + EndDepth_ft)/2)*0.305) %>% 
  group_by(TrawlType, Year, Season) %>% 
  summarize(`Mean Depth (m)` = mean(mean_depth, na.rm = TRUE),
            `Depth SE` = sd(mean_depth, na.rm = TRUE)/sqrt(n())) %>% 
  knitr::kable()
```

# Abundance

## Bar Chart

The error bars on this plot are estimated via a two-stage bootstrap, by taking the standard deviation of the mean, sampling with replacement from both sites and trawl samples within sites. Unless otherwise stated, this applies to all other plots with error bars.

```{r abundance_plot}
filter_trawls <- function(data) {
  data %>%
  filter(Year %in% c("2006", "2007", "2016", "2017")) %>%
  filter(Season != "Spring") %>% 
  filter(Site != "Beam 3") %>%
  mutate(Period = ifelse(grepl("200", Year), "Pre-Decline", "Post-Decline") %>% 
           factor(levels = c("Pre-Decline", "Post-Decline"),
                  ordered = TRUE))
}

abundance <- 
  read_excel(trawl_path, "Fish Count Data Corrected") %>% 
  filter_trawls %>% 
  group_by(Period, Season, Year, TrawlType, Site, Replicate) %>% 
  summarize(Count = sum(Count)) %>% 
  ungroup()

abundance_summary <- abundance %>% 
  group_by(Period, Season, TrawlType) %>%
  cluster_bootstrap(Count, Site) %>% ungroup() %>% 
  mutate(Period = factor(Period, levels = c("Pre-Decline", "Post-Decline"),
                         ordered = TRUE), 
         TrawlType = dplyr::recode(TrawlType, "Beam" = "Intertidal Flats", 
                                       "Otter" = "Channel"))

abundance_summary %>%
  ggplot(aes(Period, mean, fill = Season)) +
  geom_bar(stat = "identity", position = "dodge", 
           color = "black", size = 0.8) + 
  scale_y_continuous(expand = c(0,0), breaks = seq(0, 140, 15), 
                     limits = c(0, max(abundance_summary$upper + 0.2))) +
  scale_fill_manual(values = c("grey80", "grey50")) +
  facet_wrap(~TrawlType, ncol = 2) +
  geom_errorbar(aes(x = Period, ymin = lower, ymax = upper), 
                position = position_dodge(width = 0.9), 
                width = 0.4, size = 0.8) +
  theme_trawls +
  theme(axis.title.x = element_blank()) +
  ylab("Total Fish Abundance (Count/Trawl)")
```

Here, I fit separate generalized linear models for Otter and Beam trawls, where the response is total fish abundance (the total number of fish per trawl replicate), and the predictors are period, season, trawl site, and an interaction between period and season. The model uses a negative binomial error distribution and a log link. As for all analyses, site Beam 3 was excluded, and only data from Fall and Summer trawls were used.

**How to Interpret this Table:** These are likelihood ratio tests, which are generated by dropping each term (and all higher order interactions it's involved in, if any) from the full model to produce a "reduced" model, which is then compared to the full model using the log-likelihood of both models. The "Df" column is the degrees of freedom of a $\mathcal{X}^2$ distribution; it is the difference between the number of parameters in the full and reduced models. The "LR Chisq" column is the associated test statistic, which by Wilk's theorem is twice the difference in the log-likelihoods of the full and reduced model. The provided p-values, which are compared to a "significance" threshold of $\alpha = 0.05$, are the probability of observing a value as or more extreme than the given test statistic under a $\mathcal{X}^2$ distribution with the given degrees of freedom. 

## Channel Model

In the channel, we find a significant difference in abundance before and after eelgrass decline, as well as a significant interaction between period and season.

```{r count_model_otter}
otter_glm_nbinom <- MASS::glm.nb(
  Count ~ Period*Season + Site, 
  data = abundance[abundance$TrawlType == "Otter",]
)

otter_glm_nbinom %>% 
  car::Anova(test.statistic = "LR") %>% as.data.frame() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>%
  knitr::kable()
```

### Pairwise Comparisons

Provided are pairwise comparisons for trawls conducted during each period and season in the channel. Abundance does not differ significantly between the Fall of the pre-decline and post-decline periods, but otherwise differs between all period/season combinations, including seasons within the same sampling period.

```{r count_pairwise_otter}
otter_glm_pairwise <- emmeans(
  otter_glm_nbinom,
  pairwise ~ Period:Season, 
  data = abundance[abundance$TrawlType == "Otter",],
  adjust = "fdr"
)

otter_glm_nbinom %<>% summary()

otter_glm_pairwise$contrasts %>% 
  as.data.frame() %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

## Mudflats Model 

Model structure is identical to the channel abundance model presented above. Only the season term is significant, so no pairwise comparisons were fitted.

```{r count_model_beam}
beam_glm_nbinom <- MASS::glm.nb(
  Count ~ Period*Season + Site, 
  data = abundance[abundance$TrawlType == "Beam",]
)

beam_glm_nbinom %>%
  car::Anova(test.statistic = "LR") %>% as.data.frame() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>%
  knitr::kable()
```

# Biomass

## Bar Chart

```{r biomass_plot}
biomass <- 
  readxl::read_excel(trawl_path, sheet = "Fish Length Data Corrected") %>% 
  filter_trawls() %>% 
  mutate(spec_binomial = paste(Genus, Species)) %>% 
  group_by(Period, Season, Year, TrawlType, Site, Replicate) %>% 
  summarize(biomass = sum(weight_g))

biomass_summary <- biomass %>%
  group_by(Period, Season, TrawlType) %>%
  cluster_bootstrap(biomass, Site) %>% ungroup() %>% 
  mutate(Period = factor(Period, levels = c("Pre-Decline", "Post-Decline"),
                         ordered = TRUE), 
         TrawlType = dplyr::recode(TrawlType, "Beam" = "Intertidal Flats", 
                                       "Otter" = "Channel"))

biomass_summary %>% 
  ggplot(aes(Period, mean, fill = Season)) +
  geom_bar(stat = "identity", position = "dodge", 
           color = "black", size = 1) + 
  scale_y_continuous(expand = c(0,0), breaks = seq(0, 1000, 100), 
                     limits = c(0, max(biomass_summary$upper + 5))) +
  scale_fill_manual(values = c("grey80", "grey50")) +
  facet_wrap(~TrawlType, ncol = 2) +
  geom_errorbar(aes(x = Period, ymin = lower, ymax = upper), 
                position = position_dodge(width = 0.9), 
                width = 0.4, size = 1) +
  theme_trawls + 
  theme(axis.title.x = element_blank()) +
  ylab("Total Fish Biomass (g/Trawl)")
```

## Plot: Biomass & Abundance

```{r biomass_abundance_plot, echo = FALSE, fig.height = 8}
bio_count_summary <- biomass_summary %>% 
  mutate(type = "biomass") %>% 
  full_join(mutate(abundance_summary, type = "abundance")) %>% 
  split(.$TrawlType)


bio_count_plot <- function(df, title, legend_pos = "none", interval = 20) {
  
  if (unique(df$type) == "abundance") {
    ylab = "Total Abundance (count/trawl)"
  } else {
    ylab = "Total Biomass (g/trawl)"
  }
  
  ggplot(df, aes(Period, mean, color = Season)) + 
    geom_errorbar(aes(x = Period, ymin = lower, ymax = upper), 
                  position = position_dodge(width = 0.9), 
                  width = 0.4, size = 1) + 
    geom_line(aes(x = as.numeric(as.factor(Period))),  
              position = position_dodge(width = 0.9), 
              size = 1.1) + 
    geom_point(position = position_dodge(width = 0.9), 
               size = 2, stroke = 1.1, shape = 21, 
               fill = "white") + 
    scale_color_manual(values = c("grey50", "black")) +
    scale_y_continuous(expand = c(0,0), limits = c(0, max(df$upper * 1.05)),
                       breaks = seq(0, max(df$upper), interval)) +
    theme_trawls +
    theme(axis.title.y = element_text(size = 16, face = "bold"),
          plot.title = element_text(size = 18, face = "bold", hjust = 0),
          axis.title.x = element_blank(), 
          legend.position = legend_pos,
          legend.text = element_text(size = 18),
          legend.title = element_text(size = 18, face = "bold"),
          axis.text.y = element_text(size = 14),
          axis.text.x = element_text(size = 16)) + 
    labs(y = ylab, fill = "Season ", title = title)
}

legend_bars <- 
  bio_count_summary$`Intertidal Flats` %>% 
  filter(type == "abundance") %>% 
  mutate(Season = paste0(Season, " ")) %>% 
  bio_count_plot("", "bottom") %>% 
  ggplot_build() %>% 
  ggplot_gtable()


legend_bottom <- which(sapply(legend_bars$grobs, function(x) x$name) == "guide-box")
legend_bottom <- legend_bars$grobs[[legend_bottom]]

mudflats_count <- 
  bio_count_summary$`Intertidal Flats` %>% 
  filter(type == "abundance") %>% 
  bio_count_plot("a. Intertidal Flats Fish Count") + 
  theme(plot.margin = margin(b = 12))

mudflats_biomass <-
  bio_count_summary$`Intertidal Flats` %>% 
  filter(type == "biomass") %>% 
  bio_count_plot("b. Intertidal Flats Fish Biomass",
                 interval = 40) + 
  theme(plot.margin = margin(b = 12))

channel_count <-
  bio_count_summary$`Channel` %>% 
  filter(type == "abundance") %>% 
  bio_count_plot("c. Channel Fish Count", 
                 interval = 25) + 
  theme(plot.margin = margin(12))

channel_biomass <- 
  bio_count_summary$`Channel` %>% 
  filter(type == "biomass") %>% 
  bio_count_plot("d. Channel Fish Biomass", 
                 interval = 100) + 
  theme(plot.margin = margin(12))

line = cowplot::ggdraw() +
  cowplot::draw_line(x = c(-Inf, Inf), y = c(0.5, 0.5), 
                     color = "black", size = 1)

cowplot::plot_grid(arrangeGrob(mudflats_count, mudflats_biomass, ncol = 2), line, 
                   arrangeGrob(channel_count, channel_biomass, ncol = 2) , 
                   legend_bottom, nrow = 4, rel_heights = c(6, 0.1, 6, 0.8))
```

```{r echo = FALSE}
ggsave(here("figures", "biomass_count_plot.tiff"), width = 20, height = 17, 
       units = "in", scale = 0.5, dpi = 500)
```


## Channel Model

Model structure is the same as for abundance models, but with a Gamma error distribution. Likelihood ratio tests are calculated as above.

```{r biomass_model_otter}
otter_biomass_glm <- glm(
  biomass ~ Period*Season + Site, 
  family = Gamma(link = "log"),
  data = biomass[biomass$TrawlType == "Otter", ]
)

otter_biomass_glm %>% 
  car::Anova(test.statistic = "LR") %>%
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

### Pairwise Comparisons

Because there was a significant period by season interaction, pairwise comparisons were fit. P-values are adjusted using the Benjamini & Hochberg method, as above. Biomass is significantly different between the summer of the pre-decline and post-decline periods, as well as between the fall and summer in the pre-decline period, but it otherwise unchanged.  

```{r biomass_pairwise_otter}
otter_biomass_pairwise <- emmeans(
  otter_biomass_glm,
  pairwise ~ Period:Season, 
  data = biomass[biomass$TrawlType == "Otter",], 
  adjust = "fdr"
)

otter_biomass_pairwise %<>% summary()

otter_biomass_pairwise$contrasts %>% as.data.frame() %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

## Mudflats Model

As for the abundance model, only season is significant, and thus no pairwise comparisons are fitted. 

```{r biomass_model_beam}
beam_biomass_glm <- glm(
  biomass ~ Period*Season + Site, 
  family = Gamma(link = "log"),
  data = biomass[biomass$TrawlType == "Beam",]
)

beam_biomass_glm %>% 
  car::Anova(test.statistic = "LR") %>% as.data.frame() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

# Species Composition

## NMDS Plot

Separate non-metric multidimensional scaling (NMDS) plots we made for each of the habits (channel and mudflats). Stress for the channel NMDS was 0.16, stress for the mudflats NMDS was 0.19. One extreme outlier was removed from the Channel plot. It contained only one individual of *Paralichthys californicus*, of which only two other individuals were observed in the study. The observation was not dropped from the PERMANOVA analysis, but the qualitative (significance test) results do not change if it is removed.

```{r nmds, results = "hide"}
species_data <- 
  readxl::read_excel(trawl_path, "Fish Count Data Corrected") %>% 
  filter_trawls() %>% 
  mutate(species = paste(Genus, Species, sep = " ")) %>% 
  dplyr::select(Period, Year, Season, TrawlType, Site, Replicate, species, Count) %>% 
  spread(species, Count) ## transform to wide format

## Columns containing species abundances
species_columns <- which(
  !(names(species_data) %in% 
      c("Period", "Year", "Season", "Site", "TrawlType", "Replicate"))
)

## Remove observations where no individuals were recorded
species_data <- species_data[rowSums(species_data[,species_columns]) > 0,]

## Channel trawls species matrix
otter_species <- species_data[species_data$TrawlType == "Otter",]
otter_matrix <- as.matrix(otter_species[,species_columns])
rownames(otter_matrix) <- with(otter_species, paste(TrawlType, Period, Season))
otter_matrix <- otter_matrix[,colSums(otter_matrix) > 0]

## Mudflat trawls species matrix
beam_species <- species_data[species_data$TrawlType == "Beam",]
beam_matrix <- as.matrix(beam_species[,species_columns])
rownames(beam_matrix) <- with(beam_species, paste(TrawlType, Period, Season))
beam_matrix <- beam_matrix[,colSums(beam_matrix) > 0]

## set random number generator seed, for reproducibility
set.seed(200)

## Fit NMDS for channel and mudflats
otter_nmds <- metaMDS(otter_matrix[-24,], distance = "bray", k = 2, trymax = 1000)
beam_nmds <- metaMDS(beam_matrix, distance = "bray", k = 2, trymax = 1000)
```

```{r nmds_plot, echo = FALSE, fig.height = 7}
## Bind NMDS results into one data frame
nmds_plot_data <- beam_nmds$points %>% 
  rbind(otter_nmds$points) %>% 
  as.data.frame() %>%
  rownames_to_column("group") %>% 
  mutate(group = trimws(gsub("[0-9.]", " ", group)), 
         group = gsub(" Decline", "-Decline", group)) %>% 
  separate(group, into = c("TrawlType", "Period", "Season"), sep = " ", 
           extra = "merge") %>% 
  mutate(Period = gsub(" ", "-", Period))

## Labels for plot panels
nmds_labels <- data.frame(
  x = -Inf, y = Inf, 
  TrawlType = factor(c("Intertidal Flats", "Channel"), ordered = TRUE), 
  label = c("a", "b")
)

## Colors for NMDS points
nmds_colors <- rep(RColorBrewer::brewer.pal(6, "Paired")[c(2, 6)], each = 2)

nmds_plot_data %>% 
  mutate(
    TrawlType = TrawlType %>% dplyr::recode( 
      "Beam" = "Intertidal Flats", 
      "Otter" = "Channel"
    ), 
    TrawlType = TrawlType %>% factor(
      levels = c("Intertidal Flats", "Channel"),
      ordered = TRUE
    ), 
    group = factor(
      paste(Period, Season), 
      levels = c("Pre-Decline Fall", "Pre-Decline Summer", 
                 "Post-Decline Fall", "Post-Decline Summer"), 
      ordered = TRUE)
  ) %>% 
  ggplot(aes(MDS1, MDS2, fill = group, pch = group, size = group)) +
  geom_point(stroke = 0.8, color = "black") +
  scale_fill_manual(values = nmds_colors) +
  scale_size_manual(values = rep(c(3, 2), 2)) + 
  scale_shape_manual(values = c(21, 24, 21, 24)) + theme_bw() +
  scale_x_continuous(breaks = seq(-1, 2, 1)) + 
  scale_y_continuous(breaks = seq(-1, 1, 1)) + 
  facet_wrap(~TrawlType, ncol = 2, scales = "free") +
  labs(x = "NMDS1", y = "NMDS2", fill = "Period & Season", 
       shape = "Period & Season", size = "Period & Season") +
  theme_trawls + 
  cowplot::panel_border("black", 1) + 
  coord_cartesian(clip = "off") + 
  theme(legend.position = "bottom") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5, 
                             nrow = 2), 
         shape = guide_legend(title.position = "top", title.hjust = 0.5, 
                             nrow = 2)) + 
   geom_text(aes(x = x, y = y, label = label), data = nmds_labels, 
            vjust = 1.5, hjust = -1, size = 7,
            inherit.aes = FALSE)
```


```{r echo = FALSE}
ggsave(here("figures", "trawl_nmds.tiff"), width = 20, height = 14, 
       units = "in", scale = 0.45, dpi = 500)
```


## PERMANOVA

For each habitat type, we fit a permutational multivariate analysis of variance (PERMANOVA) on a Bray-Curtis dissimilarity matrix of species abundance with 10,000 permutations. We used period, season, site, and the interaction between period and season as predictors, and sites as strata (although p-values for period, season, and their interaction are near-identical regardless of how sites are included in the model). We used marginal pseudo-F tests to evaluate the significance of model terms.

### Channel Model

All model terms are significant, except site.

```{r channel_permanova}
set.seed(200)

## Fit PERMANOVA
adonis_otter <- adonis2(
  otter_matrix ~ Period*Season + Site,
  data = otter_species, 
  strata = Site, 
  method = "bray", # Bray-Curtis dissimilarity
  perm = 10000
)

adonis_otter %>% as.data.frame() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

#### Pairwise Comparisons

Pairwise PERMANOVA models are fit using a wrapper function from the `RVAideMemoire` package; when the response provided is a distance matrix (in this case, Bray-Curtis dissimilarity), each comparison is fit using the `adonis` function. Pseudo-F tests are calculated for each comparison. P-values are adjusted using the Benjamini & Hochberg method. 

All pairwise comparisons are significant, except Fall pre-decline vs. post-decline.

```{r channel_permanova_pairwise}
otter_species$group <- with(otter_species, paste(Period, Season))

## Bray-Curtis dissimilarity matrix
otter_bray <- vegdist(otter_matrix, method = "bray")

set.seed(200)

## Fit pairwise PERMANOVA models
otter_permanova_pairs <- RVAideMemoire::pairwise.perm.manova(
  otter_bray,
  fact = otter_species$group, 
  nperm = 10000, 
  p.method = "fdr" # Benjamini & Hochberg
)

knitr::kable(as.data.frame(round(otter_permanova_pairs$p.value, 3)))
```

#### SIMPER

For each significant pairwise comparison of interest, we fit a similarity percentages (SIMPER), reporting abundance for species identified by the SIMPER as contributing to observed differences in community composition more than would be expected at random. For each SIMPER output, relevant species are listed, and an abundance plot is provided. 

**How to interpret this output:** This output is ordered in terms of each species contribution to the difference between groups examined. The `average` variable is the average contribution to the overall dissimilarity, and the `sd` is the standard deviation of that contribution. The `cumsum` variable is the total percent of the variation accounted for by the species and all other species above it.

Code is shown in output for the first SIMPER only, as the code is near-identical for each SIMPER.

\newpage

##### Pre-Decline Fall vs. Summer

```{r channel_simper_pre}
## functions for formatting and plotting simper results
source(here("R", "simper_functions.R"))

## Split Channel data by Period
otter_simper <- split(otter_species, otter_species$Period)
otter_simper %<>% append(split(otter_species, otter_species$Season))

otter_simper$`Pre-Decline_simper` <-
  otter_simper$`Pre-Decline`[,species_columns] %>% 
  filter_sp() %>% 
  simper(otter_simper$`Pre-Decline`$Season) %>% 
  summary %$% Fall_Summer %>% 
  format_simper() %>% 
  rename(Fall = ava, Summer = avb)

knitr::kable(otter_simper$`Pre-Decline_simper`)

with(otter_simper, 
     sum_abundance(`Pre-Decline`, `Pre-Decline_simper`$Species, "Season")) %>%
  plot_abundance("Season")
```

\newpage

##### Post-Decline Fall vs. Summer

```{r channel_simper_post, echo = FALSE}
otter_simper$`Post-Decline_simper` <-
  otter_simper$`Post-Decline`[,species_columns] %>% 
  filter_sp() %>% 
  simper(otter_simper$`Post-Decline`$Season) %>% 
  summary %$% Fall_Summer %>% 
  format_simper() %>% 
  rename(Fall = ava, Summer = avb)

knitr::kable(otter_simper$`Post-Decline_simper`)

with(otter_simper, 
     sum_abundance(`Post-Decline`, `Post-Decline_simper`$Species, "Season")) %>%
  plot_abundance("Season")
```

\newpage

##### Summer Pre-Decline vs. Post-Decline

```{r channel_simper_summer, echo = FALSE}
otter_simper$Summer_simper <-
  otter_simper$Summer[,species_columns] %>% 
  filter_sp() %>% 
  simper(otter_simper$Summer$Period) %>% 
  summary %$% `Pre-Decline_Post-Decline` %>% 
  format_simper() %>% 
  rename(`Pre-Decline` = ava, `Post-Decline` = avb)

knitr::kable(otter_simper$Summer_simper)

with(otter_simper, 
     sum_abundance(Summer, Summer_simper$Species, "Period")) %>%
  plot_abundance("Period")
```


### Mudflats Model

Model structure is as described above. All model terms are significant. 

```{r mudflats_permanova}
set.seed(200)

## Fit PERMANOVA
adonis_beam <- adonis2(
  beam_matrix ~ Period*Season + Site,
  data = beam_species, 
  strata = Site, 
  method = "bray", # Bray-Curtis dissimilarity
  perm = 10000
)

adonis_beam %>% as.data.frame() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

#### Pairwise Comparisons

Pairwise comparisons are as described above. All pairwise comparisons are significant.

```{r mudflats_permanova_pairwise}
beam_species$group <- with(beam_species, paste(Period, Season))

## Bray-Curtis dissimilarity matrix
beam_bray <- vegdist(beam_matrix, method = "bray")

set.seed(200)

## Fit pairwise PERMANOVA models
beam_permanova_pairs <- RVAideMemoire::pairwise.perm.manova(
  beam_bray,
  fact = beam_species$group, 
  nperm = 10000, 
  p.method = "fdr" # Benjamini & Hochberg
)

knitr::kable(as.data.frame(round(beam_permanova_pairs$p.value, 3)))
```

\newpage

#### SIMPER

##### Pre-Decline Fall vs. Summer

```{r mudflats_simper_pre, echo = FALSE}
beam_simper <- split(beam_species, beam_species$Period)
beam_simper %<>% append(split(beam_species, beam_species$Season))

beam_simper$`Pre-Decline_simper` <-
  beam_simper$`Pre-Decline`[,species_columns] %>% 
  filter_sp() %>% 
  simper(beam_simper$`Pre-Decline`$Season) %>% 
  summary %$% Fall_Summer %>% 
  format_simper() %>% 
  rename(Fall = ava, Summer = avb)

knitr::kable(beam_simper$`Pre-Decline_simper`)

with(beam_simper, 
     sum_abundance(`Pre-Decline`, `Pre-Decline_simper`$Species, "Season")) %>%
  plot_abundance("Season")
```

\newpage

##### Post-Decline Fall vs. Summer

```{r mudflats_simper_post, echo = FALSE}
beam_simper$`Post-Decline_simper` <-
  beam_simper$`Post-Decline`[,species_columns] %>% 
  filter_sp() %>% 
  simper(beam_simper$`Post-Decline`$Season) %>% 
  summary %$% Fall_Summer %>% 
  format_simper() %>% 
  rename(Fall = ava, Summer = avb)

knitr::kable(beam_simper$`Post-Decline_simper`)

with(beam_simper, 
     sum_abundance(`Post-Decline`, `Post-Decline_simper`$Species, "Season")) %>%
  plot_abundance("Season")
```

\newpage

##### Fall Pre-Decline vs. Post-Decline

```{r mudflats_simper_fall, echo = FALSE}
beam_simper$Fall_simper <-
  beam_simper$Fall[,species_columns] %>% 
  filter_sp() %>% 
  simper(beam_simper$Fall$Period) %>% 
  summary %$% `Pre-Decline_Post-Decline` %>% 
  format_simper() %>% 
  rename(`Pre-Decline` = ava, `Post-Decline` = avb)

knitr::kable(beam_simper$Fall_simper)

with(beam_simper, 
     sum_abundance(Fall, Fall_simper$Species, "Period")) %>%
  plot_abundance("Period")
```

\newpage

##### Summer Pre-Decline vs. Post-Decline

```{r mudflats_simper_summer, echo = FALSE}
beam_simper$Summer_simper <-
  beam_simper$Summer[,species_columns] %>% 
  filter_sp() %>% 
  simper(beam_simper$Summer$Period) %>% 
  summary %$% `Pre-Decline_Post-Decline` %>% 
  format_simper() %>% 
  rename(`Pre-Decline` = ava, `Post-Decline` = avb)

knitr::kable(beam_simper$Summer_simper)

with(beam_simper, 
     sum_abundance(Summer, Summer_simper$Species, "Period")) %>%
  plot_abundance("Period")
```

\newpage

## Plot: SIMPER Species

Species abundances (natural log (+1) before (light gray) and after (dark gray) eelgrass decline for (a) intertidal flats in the fall, (b) intertidal flats in the summer, and (c) the channel in the summer. Species composition did not differ significantly between pre-decline and post-decline periods for the channel in the fall based on a pairwise PERMANOVA. Species shown are those identified by a SIMPER analysis as contributing most to observed differences in species composition; standard errors are estimated using a two-stage bootstrap. Where there were no individuals of a species for a particular period and habitat, this is indicated with a zero. 

```{r simper_plot_full, echo = FALSE, fig.height = 8}
## This plot code is long and poorly written

## Function to bootstrap log abundance for each species
sum_log_abundance <- function(df, species, group, reps = 10000) {
  df <- df[, c("Period", "Season", "Year", "Site", species)] %>% 
    gather_("species", "count", gather_cols = species) %>% 
    group_by_(.dots = group, "species") %>% 
    mutate(count = log(count + 1)) %>% 
    cluster_bootstrap(count, Site, reps) %>% 
    mutate(lower = ifelse(lower < 0, 0, lower),
           species = gsub(" ", "\n", species)) %>% 
    ungroup()
  
  for (i in seq(nrow(df))) {
    if (df$mean[i] == 0) {
      df$mean[i]  = NA
      df$sd[i]    = NA
      df$upper[i] = NA
      df$lower[i] = NA
    }
  }
  
  df
}

## Store simpers for each pre-decline vs. post-decline comparison
trawl_simper <- list()
trawl_simper$`Channel Summer` <- otter_simper$Summer %>% 
  sum_log_abundance(otter_simper$Summer_simper$Species, c("Period"))
trawl_simper$`Intertidal Flats Fall` <- beam_simper$Fall %>% 
  sum_log_abundance(beam_simper$Fall_simper$Species, c("Period"))
trawl_simper$`Intertidal Flats Summer` <- beam_simper$Summer %>% 
  sum_log_abundance(beam_simper$Summer_simper$Species, c("Period"))

## Common names of SIMPER species for plot
common_names <- tibble(
  common =
    c("tubesnout", 
      "speckled sanddab",
      "staghorn sculpin",
      "English sole",
      "bay pipefish",
      "arrow goby",
      "shiner perch"),
  species = 
    c("Aulorhynchus\nflavidus", 
      "Citharichthys\nstigmaeus", 
      "Leptocottus\narmatus", 
      "Parophrys\nvetulus", 
      "Syngnathus\nleptorhynchus", 
      "Clevelandia\nios", 
      "Cymatogaster\naggregata")
)

## Bind Simper plot data into one data frame
simper_plot_data <- trawl_simper %>% 
  bind_rows(.id = "group") %>%
  left_join(common_names, by = "species") %>% 
  mutate(Period = fct_rev(Period), 
         common = fct_rev(factor(common)),
         label = ifelse(is.na(mean), 0, "")) %>% 
  complete(group, common, fill = list(label = "no contribution")) %>% 
  mutate(group = dplyr::recode(group, 
         "Intertidal Flats Fall" = "a. Intertidal Flats Fall", 
         "Intertidal Flats Summer" = "b. Intertidal Flats Summer",
         "Channel Summer" = "c. Channel Summer"
  ))

## Build panel a
panel_a <- simper_plot_data %>% 
  filter(grepl("a\\.", group)) %>% 
  ggplot(aes(mean, common, fill = Period)) + 
  geom_barh(stat = "identity", position = position_dodgev(height = 0.9),
            color = "black", size  = 0.8, show.legend = FALSE) + 
  geom_errorbarh(aes(xmin = lower, xmax = upper), 
                 width = 0.4, size = 0.8,
                 position = position_dodgev(height = 0.9))  + 
  geom_text(aes(x = 0.05, label = label), fontface = "bold", color = "grey60", 
            position = position_dodgev(height = 0.9), size = 5, hjust = 0) + 
  scale_fill_manual(values = c("grey30", "grey80"), 
                    breaks = c("Post-Decline", "Pre-Decline")) + 
  scale_x_continuous(limits = c(0, max(simper_plot_data$upper, na.rm = TRUE) * 1.05),
                     expand = c(0,0)) +  
  theme_trawls +
  facet_wrap(~group) + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 17),
        strip.text = element_text(hjust = 0), 
        axis.title.x = element_blank())

## Build panel b
panel_b <- simper_plot_data %>% 
  filter(grepl("b\\.", group)) %>% 
  ggplot(aes(mean, common, fill = Period)) + 
  geom_barh(stat = "identity", position = position_dodgev(height = 0.9),
            color = "black", size  = 0.8, show.legend = FALSE) + 
  geom_errorbarh(aes(xmin = lower, xmax = upper), 
                 width = 0.4, size = 0.8,
                 position = position_dodgev(height = 0.9))  + 
  geom_text(aes(x = 0.05, label = label), fontface = "bold", color = "grey60", 
            position = position_dodgev(height = 0.9), size = 5, hjust = 0) + 
  scale_fill_manual(values = c("grey30", "grey80"), 
                    breaks = c("Post-Decline", "Pre-Decline")) + 
  scale_x_continuous(limits = c(0, max(simper_plot_data$upper, na.rm = TRUE) * 1.05),
                     expand = c(0,0)) +  
  theme_trawls +
  facet_wrap(~group) + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        strip.text = element_text(hjust = 0), 
        axis.title.x = element_blank())

## Build panel c
panel_c <- simper_plot_data %>% 
  filter(grepl("c\\.", group) & nchar(label) == 0) %>% 
  ggplot(aes(mean, common, fill = Period)) + 
  geom_barh(stat = "identity", position = position_dodgev(height = 0.9),
            color = "black", size  = 0.8) + 
  geom_errorbarh(aes(xmin = lower, xmax = upper), 
                 width = 0.4, size = 0.8,
                 position = position_dodgev(height = 0.9))  + 
  geom_text(aes(x = 0.05, label = label), fontface = "bold", color = "grey60", 
            position = position_dodgev(height = 0.9), size = 5, hjust = 0) + 
  scale_fill_manual(values = c("grey30", "grey80"), 
                    breaks = c("Post-Decline", "Pre-Decline")) + 
  scale_x_continuous(limits = c(0, max(simper_plot_data$upper, na.rm = TRUE) * 1.05),
                     expand = c(0,0)) +  
  theme_trawls +
  facet_wrap(~group) + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 17),
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16, face = "bold"), 
        strip.text = element_text(hjust = 0)) + 
  labs(x = "Ln Abundance (count/trawl)", fill = "Period") + 
  guides(fill = guide_legend(reverse = TRUE))

## Top panel axis label
top_xlab <- ggplot() + 
  geom_text(aes(x = 1.8, y = 0, label = "Ln Abundance (count/trawl)"), 
            size = 6, fontface = "bold") + 
  scale_x_continuous(limits = c(0, 3)) + 
  theme_nothing()

## Build top panel
top_panel <- cowplot::plot_grid(
  cowplot::plot_grid(panel_a, panel_b, nrow = 1, 
                     rel_widths = c(0.6, 0.4)), 
  top_xlab, ncol = 1, rel_heights = c(10, 1)
)

## extract legend
simper_legend <- cowplot::get_legend(panel_c)

## remove legend from top panel
bot_panel <- cowplot::plot_grid(
  panel_c + theme(legend.position = "none"), 
  simper_legend, nrow = 1, rel_widths = c(0.6, 0.4)
)

## bind top and bottom panel together
trawl_simper_plot <- cowplot::plot_grid(top_panel, bot_panel, ncol = 1, 
                                        rel_heights = c(0.62, 0.38))

trawl_simper_plot
```

```{r echo = FALSE}
ggsave(here("figures",  "trawl_simper_plot.tiff"), trawl_simper_plot, 
       width = 18, height = 16,  units = "in", scale = 0.55, dpi = 500)
```

# Trophic Level

## Plot: Mean & SE

Mean trophic level $\pm$ standard error, for a) intertidal flats, and b) channel, in the fall and summer of the pre-decline and post-decline periods.

```{r trophic_plot, echo = FALSE}
## read in trophic level data
trophic_data <- trawl_path %>% 
  readxl::read_excel("fishbase data") %>% 
  dplyr::select(sciname, trophic_level)

## bind species counts to trophic level data
trophic_data <- trawl_path %>% 
  readxl::read_excel("Fish Count Data Corrected") %>% 
  filter_trawls() %>% 
  mutate(sciname = paste(Genus, Species)) %>% 
  left_join(trophic_data)

## Summarize mean trophic level and sample size
trophic_lm_data <- 
  trophic_data %>% 
  filter(Count > 0) %>% 
  mutate(trophic_level = trophic_level*Count) %>%
  group_by(TrawlType, Site, Period, Year, Season, Replicate) %>% 
  summarize(trophic_level = sum(trophic_level),
            count = sum(Count)) %>%
  ungroup() %>% 
  mutate(trophic_level = trophic_level/count)

## Bootstrap error bars
trophic_summary <-
  trophic_lm_data %>% 
  group_by(Period, Season, TrawlType) %>%
  cluster_bootstrap(trophic_level, Site) %>% ungroup() %>% 
  mutate(Period = factor(Period, levels = c("Pre-Decline", "Post-Decline"),
                         ordered = TRUE))

## Labels for plot
trophic_labels <- data.frame(
  x = -Inf, y = Inf,
  TrawlType = factor(c("Intertidal Flats", "Channel"), ordered = TRUE), 
  label = c("a", "b")
)

## Plot trophic level mean and SE
trophic_summary %>%
  mutate(TrawlType = dplyr::recode(TrawlType, "Beam" = "Intertidal Flats", 
                                       "Otter" = "Channel"), 
         TrawlType = fct_rev(factor(TrawlType))) %>% 
  ggplot(aes(Period, mean, color = Season)) +
  geom_errorbar(aes(x = Period, ymin = lower, ymax = upper), 
                position = position_dodge(width = 0.9), 
                width = 0.4, size = 1) +
  geom_point(aes(shape = Season, size = Season), 
             position = position_dodge(width = 0.9), 
             fill = "white", stroke = 1.2) + 
  scale_y_continuous(expand = c(0,0), limits = c(3,4)) +
  scale_color_manual(values = c("grey50", "black")) +
  scale_shape_manual(values = c(21, 16)) + 
  scale_size_manual(values = c(2, 2.5)) + 
  lemon::facet_rep_wrap(~TrawlType, ncol = 2) +
  theme_trawls +
  ylab("Trophic Level") + 
  coord_cartesian(clip = "off") + 
  theme(axis.ticks = element_line(color = "black"), 
        strip.text = element_text(size = 18),
        axis.text = element_text(size = 16), 
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16), 
        axis.title = element_text(size = 18)) + 
  geom_text(aes(x = x, y = y, label = label), data = trophic_labels, 
            vjust = 1, hjust = -1, size = 7,
            inherit.aes = FALSE)
```


```{r echo = FALSE}
ggsave(here("figures", "trophic_level.tiff"), width = 18, height = 10, 
       units = "in", scale = 0.55, dpi = 500)
```

## Channel Model

We assessed changes in average sample trophic level with linear regression, weighted by the number of individuals in each trawl. Trophic level estimates were gathered from FishBase; most species estimates were from diet studies, but some were Bayesian estimates based on nearest relatives.

In the channel, we find a general increase in trophic level across both fall and summer samples following eelgrass decline (p < 0.001), with no interaction (p = 0.65) between period and season, suggesting the magnitude of increase was similar across seasons.

```{r trophic_lm_channel}
## Fit linear model
otter_trophic_lm <- lm(
  trophic_level ~ Period*Season + Site, 
  weights = count,
  data = trophic_lm_data[trophic_lm_data$TrawlType == "Otter",]
)

## F-tests
otter_trophic_lm %>% anova() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

## Mudflats Model 

We also find a significant increase in mean-sample trophic level following eelgrass decline in the mudflats (p < 0.001), but with an interaction between period and season (p = 0.001), suggesting the magnitude of the increase differed between fall and summer.

```{r trophic_lm_mudflats}
## Fit linear model
beam_trophic_lm <- lm(
  trophic_level ~ Period*Season + Site, 
  weights = count,
  data = trophic_lm_data[trophic_lm_data$TrawlType == "Beam",]
)

## F-tests
beam_trophic_lm %>% anova() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

### Pairwise Comparisons

While the average difference between pre-decline and post-decline samples was greater in the summer, we find find significant increases in trophic level during both the fall (p = 0.014) and summer (p < 0.001) following eelgrass decline.

```{r}
beam_trophic_pairwise <- emmeans(
  beam_trophic_lm, 
  pairwise ~ Period:Season, 
  data = trophic_lm_data[trophic_lm_data$TrawlType == "Beam",],
  adjust = "fdr"
)

beam_trophic_pairwise %<>% summary() 

beam_trophic_pairwise$contrasts %>% 
  as.data.frame() %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

# Species Richness

## Per-sample Richness

### Plot: Mean & SE

```{r}
## Summarize number of species per sample
richness <- trawl_path %>% 
  readxl::read_excel("Fish Count Data Corrected") %>% 
  filter_trawls() %>% 
  mutate(species = paste(Genus, Species)) %>% 
  filter(Count > 0) %>% 
  group_by(TrawlType, Period, Year, Season, Site, Replicate) %>% 
  summarize(richness = length(unique(species)))

richness %>% 
  group_by(TrawlType, Period, Season) %>% 
  summarize(mean = mean(richness), 
            se = sd(richness)/sqrt(n())) %>% 
  ggplot(aes(Period, mean, color = Season)) +
  geom_point(position = position_dodge(width = 0.9), size = 3) + 
  scale_y_continuous(expand = c(0,0), limits = c(2, 5)) +
  scale_color_manual(values = c("grey60", "black")) +
  facet_wrap(~TrawlType, ncol = 2) +
  geom_errorbar(aes(x = Period, ymin = mean - se, ymax = mean + se), 
                position = position_dodge(width = 0.9), 
                width = 0.4, size = 1) +
  theme_trawls +
  ylab("Mean Sample Richness") + 
  annotate("segment", x = -Inf, xend = -Inf, y = -Inf, yend = Inf, size = 1) +
  coord_cartesian(clip = "off")
```

### Linear Model

```{r}
richness_lm <- lm(richness ~ Period*Season + Site, data = richness)

richness_lm %>% anova() %>% 
  rownames_to_column("term") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  knitr::kable()
```

## Rarefaction Curves

```{r}
## Read in trawl species counts
trawl_counts <- trawl_path %>% 
  readxl::read_excel("Fish Count Data Corrected") %>% 
  filter_trawls() %>% 
  mutate(species = paste(Genus, Species)) %>% 
  select(Period, Year, Season, TrawlType, Site, Replicate, 
         species, Count) %>% 
  pivot_wider(names_from = species, values_from = Count) 

## Fit species accumulation curves for each subset
species_accum <- trawl_counts %>% 
  group_by(TrawlType, Period, Season) %>% 
  nest() %>% 
  mutate(
    species = map(data, dplyr::select, -Year, -Site, -Replicate), 
    spec_accum = map(species, specaccum), 
    spec_accum = map(spec_accum, function(x) {
      tibble(site = x$sites, richness = x$richness, sd = x$sd) 
    })
  ) %>% 
  dplyr::select(TrawlType, Period, Season, spec_accum) %>% 
  unnest(cols = c(spec_accum)) %>% 
  ungroup()
  
## Plot species accumulation curves
species_accum %>%
  mutate(
    site = ifelse(Season == "Summer", site + 0.2, site - 0.2), ## x-offset
    Season = paste0(" ", Season, " "), ## for legend
    TrawlType = dplyr::recode(TrawlType, 
                              "Beam" = "Intertidal Flats", 
                              "Otter" = "Channel"),
    group = fct_rev(factor(paste(TrawlType, Period))),
    group = paste(letters[group], group, sep = ". ")
  ) %>% 
  ggplot(aes(site, richness, color = Season, fill = Season)) + 
  geom_point() +
  lemon::facet_rep_wrap(~group, ncol = 2) + 
  geom_linerange(aes(ymin = richness - sd, ymax = richness + sd)) +
  scale_color_manual(values = c("red", "black")) +
  labs(x = "Sites", y = "Cumulative Species Count") +
  scale_y_continuous(expand = c(0,0), breaks = seq(0, 15, 5), limits = c(0, 19)) + 
  scale_x_continuous(expand = c(0,0), breaks = seq(0, 15, 5), limits = c(0, 19)) +
  theme_trawls +
  theme(strip.text = element_text(hjust = 0), 
        legend.position = "bottom",
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16, face = "bold"), 
        panel.spacing.y = unit(1, "lines")) + 
  coord_cartesian(clip = "off")
```

## Assymptotic Richness

### Plot

```{r}
format_iNEXT <- function(df) 1*(t(df) > 0)

trawl_counts_nested <- trawl_counts %>% 
  group_by(TrawlType, Period, Season) %>% 
  nest(sp_subset, .key = "sp_matrix") %>% 
  mutate(sp_matrix = map(sp_matrix, format_iNEXT), 
         richness = map(sp_matrix, ChaoRichness, datatype = "incidence_raw"), 
         shannon = map(sp_matrix, ChaoShannon, datatype = "incidence_raw"))

 trawl_counts_nested %>% 
  dplyr::select(TrawlType, Period, Season, richness) %>% 
  unnest() %>% 
  mutate(upper = `95% Lower`, 
         lower = `95% Upper`, 
         TrawlType = dplyr::recode(TrawlType, "Beam" = "Intertidal Flats", 
                                       "Otter" = "Channels")) %>% 
  ggplot(aes(Period, Estimator, color = Season, group = Season)) +
  geom_point(position = position_dodge(width = 0.9), size = 3) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.3,
                position = position_dodge(width = 0.9),
                size = 1) +
  facet_wrap(~TrawlType) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20), expand = c(0,0)) +
  scale_color_manual(values = c("grey60", "black")) +
  ylab("Species Richness") +
  theme_trawls + 
  theme(axis.title.x = element_blank(), 
        axis.title = element_text(size = 14, face = "bold")) + 
  annotate("segment", x = -Inf, xend = -Inf, y = -Inf, yend = Inf, size = 1) + 
  coord_cartesian(clip = "off")
```

### Table

```{r}

```


# Shannon Diversity















